---
title: "Aula 6"
format: html
editor: visual
editor_options: 
  chunk_output_type: console
---

## Inferencial

### Dois grupos independentes

```{r}
library(gsheet)
mg <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1bq2N19DcZdtax2fQW9OHSGMR0X2__Z9T/edit#gid=983033137")

mg


```

## Visualiza

```{r}
library(tidyverse)
mg %>% 
  ggplot(aes(trat, comp)) +
  geom_boxplot()

```

Preciso dos vetores separados para fazer teste t (t.test) Antes Preciso sair do formato longo para o largo, porque o teste t exige isso mg2- serie de dados para cada um. Separar mg e control \$- coluna mg2 e a coluna control

```{r}

mg2 <- mg %>% 
  pivot_wider(names_from = trat,
              values_from = comp)


teste1 <- t.test(mg2$Mg2, mg2$control)


```

Interpretando o teste t:

A média calcula do mg 10.52 e media do controle 15.678 a área é p-value = 2.423e-07, o p-valor quer dizer que é a probabilidade de encontrar um valor igual ou menor que ele. df- grau de liberdade. Rejeita hipose nula, que 10.520 é igual ao 15.678, estatisticamente eles são diferentes.

##teste da normalidade

variaveis numericas continuas tende a ter uma nornamalidade de distribuição. Em relação a normalidade está ok-

```{r}

shapiro.test(mg2$control)
shapiro.test(mg2$Mg2)
hist(mg2$control)
hist(mg2$Mg2)



```

## variancias homogeneas

O valor do F é baixo, mostra que está no meio. As variancias são homogeneas.

```{r}
var.test(mg2$control, mg2$Mg2)
```

Posso continuar com o teste t normal. Verificar as premicias de....

Analie parametrica- tipo caso

#Esse procedimento gráfico mostra que os pontos segue a tendencia da linha.

```{r}
qqnorm(mg2$control)
qqline(mg2$control)


qqnorm(mg2$Mg2)
qqline(mg2$Mg2)



```

# O Report faz o texto para pode ser usado no artigo:

"The Welch Two Sample t-test testing the difference between mg2$Mg2 and mg2$control (mean of x = 10.52, mean of y = 15.68) suggests that the effect is negative, statistically significant, and large (difference = -5.16, 95% CI \[-6.49, -3.83\], t(17.35) = -8.15, p \< .001)" Pode parar aqui. Opcional - "Cohen's d = -3.65, 95% CI \[-5.12, -2.14\])"

```{r}
library(report)
report(teste1)
```

## Dois grupos dependentes

```{r}

escala <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1bq2N19DcZdtax2fQW9OHSGMR0X2__Z9T/edit#gid=1729131173")


```

```{r}
escala %>% 
  ggplot(aes(assessment, acuracia))+
  geom_boxplot()
```

## Aplicar o test t

Está no formato longo e tenho que passar para o formato largo.

```{r}

escala2 <- escala %>% 
  select(assessment, rater, acuracia) %>% 
  pivot_wider(names_from = assessment,
              values_from = acuracia)

```

## teste

Testar as premicias de variancia e ....

Coloca o argumento de pareamento

```{r}

shapiro.test(escala2$Unaided)
shapiro.test(escala2$Aided1)


```

Não rejeito a hipotese nula, é normal

Variacia

```{r}
var.test(escala2$Unaided, escala2$Aided1)
```

As variancia são hetrogena

```{r}
t.test(escala2$Aided1, escala2$Unaided, 
       paired = TRUE,
       var.equal = FALSE)

```

p-value = 0.0002087, rejeito a hipotese nula.

Variancia heterogenia e distribuição normal A media das diferenças é 0.183

Isso que faz quando tem situação de dependencia.

## Teste não parametrico: usamos pq no shapiro.teste deu "erro"

Wilcoxon

```{r}

wilcox.test(escala2$Aided1,
            escala2$Unaided,
            paired = TRUE)


```

Rejeito a hipotese nula.

```{r}
wilcox.test(mg2$control, mg2$Mg2,
            paired = FALSE)
```

## 3 ou mais grupos

```{r}

micelial <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1bq2N19DcZdtax2fQW9OHSGMR0X2__Z9T/edit#gid=959387827")


```

```{r}

tcm %>%
  ggplot(aes(especie, tcm)) +
  geom_jitter(width = 0.05)



```

## Anova

Quadro da anova (lm) -1 (da diretameto os valores medios)

```{r}


m1 <- lm(tcm ~ especie-1, data = micelial)
anova(m1)
summary(m1)
hist(m1$residuals)
shapiro.test(m1$residuals)
bartlett.test(tcm ~ especie, data = micelial)



```

Em relação a normalidade está ok: hist(m1$residuals) Variancia é homogenea: p-value = 0.3501 shapiro.test(m1$residuals)

Conclusão: não ha efeito das especies, as media variam entre .... sem difereça estatistica e so numerica

## comparar as medias que diferem

```{r}

library(emmeans)
medias1 <- emmeans(m1, ~especie)

library(multcomp)
library(multcompView)
cld(medias1)

```

## faz a mesma coisa do de baixo

```{r}
library(DHARMa)
plot(simulateResiduals(m1))

```

## Alternativa para conferir as premicias

```{r}

library(performance)
library(see)
check_normality(m1)
check_heteroscedasticity(m1)
check_model(m1)


```

#Aula 7 InsectSprays(conjunto de dados)- aplicação de fungicidas anova unifatorial- so tem um fator

```{r}

inseticida <- InsectSprays
library(tidyverse)
inseticida %>% 
  count(spray)




```

#Explorar de forma visual variancias heterogenias - F tem mais

```{r}
theme_set(theme_bw())

inseticida %>% 
  ggplot(aes(spray, count)) +
  geom_boxplot()
  

```

#ajusta o modelo de anova e depois trabalha com os residuos da anova. Pacote performace e darm shapiro- não tem normalidade O que fazemos: 1- testar aplicando alguma transformação e adquirir uma normalidade. (log de x) dados de contagem- raiz quadrada é a melhor opção

```{r}
library(performance)
m1 <- lm(count ~ spray,
         data = inseticida)
summary(m1)
anova(m1)

library(emmeans)
m1_medias <- emmeans(m1, ~ spray)
plot(m1_medias)
library(multcomp)
cld(m1_medias)


m1$residuals
hist(m1$residuals)
qqnorm(m1$residuals)
qqline(m1$residuals)
shapiro.test(m1$residuals)
bartlett.test(count ~ spray,
              data = inseticida)


#substituir tudo que fizemos acima  pela bbt performace
 

library(performance)
check_normality(m1)
check_heteroscedasticity(m1)

library(DHARMa)
plot(simulateResiduals(m1))


```

## alternativa 1 - transformação de raiz quadrada

```{r}

inseticida <- inseticida %>% 
  mutate(count2 = sqrt(count))

inseticida %>% 
  ggplot(aes(spray, count2)) +
  geom_boxplot()


```

```{r}
m2 <- lm(count2 ~ spray,
         data = inseticida)
summary(m2)
anova(m2)

library(emmeans)
m2_medias <- emmeans(m2, ~ spray)
plot(m2_medias)
library(multcomp)
cld(m2_medias)

pwpm(m2_medias)
pwpp(m2_medias)
pairs(m2_medias)

m2$residuals
hist(m2$residuals)
qqnorm(m2$residuals)
qqline(m2~residuals)
shapiro.test(m2$residuals)
bartlett.test(count ~ spray,
              data = inseticida)
shapiro.test(m2$residuals)
bartlett.test(count2 ~ spray,
              data = inseticida)

library(performance)
check_normality(m2)
check_heteroscedasticity(m2)

library(DHARMa)
plot(simulateResiduals(m2))

# transformação - Box-Cox
##lambda é um valor de x onde o y é máximo

library(MASS)
b <- boxcox(lm(inseticida$count + 0.1 ~1))
lambda <- b$x[which.max(b$y)]
lambda 

## criar a variavel trnasformada
### depois que acha o lambda eu transformo

inseticida$count3 <- (inseticida$count ^ lambda - 1) / lambda
inseticida$count3

```

## Alternativa 2- teste não parametrico

saida do count sem trasnformar faz um ranqueamento a hipotese nula é que as medias são iguais e rejeita a hipotese nula- p-value = 1.511e-10

```{r}

library(agricolae)
kruskal.test(count ~ spray,
             data = inseticida)

m3 <- kruskal(inseticida$count,
        inseticida$spray,
        group = TRUE)
m3


```

## Alternativa 3 - GLMs (usar no artigo)

Generalizado mais bonito e aceito. coloco a familia poisson.

```{r}
m4 <- glm(count ~ spray,
          family = poisson,
          data = inseticida)
summary(m4)
anova(m4)
library(car)
Anova(m4)
plot(simulateResiduals(m4))
m4_medias <- emmeans(m4, ~ spray.
                     type = "response")
cld(m4_medias)

```

## Anova fatorial - planilha google

```{r}
library(gsheet)
li <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1bq2N19DcZdtax2fQW9OHSGMR0X2__Z9T/edit#gid=2023059672")


```

```{r}

library(tidyverse)


li %>% 
  ggplot(aes(factor(dose), severity, color =  factor(dose))) +
  geom_jitter(width = 0.1) +
  facet_wrap(~ treat)



```

dica de tema: colocar no inicio do documento --\> theme_set(theme_bw()) e todo os graficos abaixo tera essa configuração

## Modelo Fatorial (two-way anova)

1º faz isso

```{r}


mf <- lm(severity ~  treat*dose,
         data = li)

mf
anova(mf)


```

##Testar as premisas apos fazer a anova não teve problema de normalidade de residuo 2º faz isso

```{r}
#DARMa mais confiavel 
plot(simulateResiduals(mf))


#check_normality(mf)
#check_heteroscedasticity(mf)
```

# Comparar as médias

3º faz isso atraves do emmeans

## Estimar as médias

LI (0.5 e 2) e Teb (0.5 e 2) A - comparam os fungicidas na mesma dose a - comparam as doses dentro do mesmo fungicida

```         
0.5     2
```

LI Aa Ab TEB Ba Aa

#Comparar as colunas Compara a mesma dose para dois fungicidas diferentes 0.5 - LI e TEB 2- LI e TEB

```{r}

mf_medias <- emmeans(mf, ~ treat | dose)
cld(mf_medias)

```

#Comparar as linhas Compara o mesmo fungicida (LI- 0.5 e 2 ou TEB- 0.5 e 2 ) paras as diferentes doses

```{r}
mf_medias <- emmeans(mf, ~ dose | treat)
cld(mf_medias)
```

```         
0.5              2
```

LI 0.29 Aa 0.05 Ab TEB 0.02 Ba 0.02 Aa
